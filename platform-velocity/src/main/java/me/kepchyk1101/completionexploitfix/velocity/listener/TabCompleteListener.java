package me.kepchyk1101.completionexploitfix.velocity.listener;

import com.velocitypowered.api.proxy.Player;
import com.velocitypowered.proxy.protocol.packet.TabCompleteRequestPacket;
import dev.simplix.protocolize.api.Direction;
import dev.simplix.protocolize.api.listener.AbstractPacketListener;
import dev.simplix.protocolize.api.listener.PacketReceiveEvent;
import dev.simplix.protocolize.api.listener.PacketSendEvent;
import me.kepchyk1101.completionexploitfix.commons.TabCompleteValidator;
import net.kyori.adventure.text.Component;
import net.kyori.adventure.text.format.NamedTextColor;

public class TabCompleteListener extends AbstractPacketListener<TabCompleteRequestPacket> {

    public TabCompleteListener() {
        super(TabCompleteRequestPacket.class, Direction.UPSTREAM, 1);
    }

    @Override
    public void packetReceive(PacketReceiveEvent<TabCompleteRequestPacket> packetReceiveEvent) {

        String request = packetReceiveEvent.packet().getCommand();

        if (TabCompleteValidator.isRequestValid(request)) {
            return;
        }

        packetReceiveEvent.cancelled(true);

        Player player = packetReceiveEvent.player().handle();
        player.disconnect(Component.text("Attempted exploit!").color(NamedTextColor.RED));

    }

    @Override
    public void packetSend(PacketSendEvent<TabCompleteRequestPacket> packetSendEvent) {

    }

}
